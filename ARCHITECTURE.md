# 🏗️ ARCHITECTURE.md

## Tata Oro WhatsApp Consultation Assistant – Architecture Overview

## 📁 New Project Structure

```bash
tataoro-assistant/
├── workers/                  # Edge runtimes for request handling and background jobs
│   ├── router.js             # Central HTTP router
│   ├── whatsapp-incoming.js  # Twilio webhook handler
│   ├── images.js             # Public image delivery
│   ├── admin.js              # Lightweight dashboard
│   ├── summary.js            # Read-only transcript view
│   ├── upload-hook.js        # GitHub webhook to trigger doc sync
│   ├── doc-sync.js           # Manual document ingestion
│   └── scheduler.js          # Cron tasks: email summaries & nudges
├── shared/                   # Reusable utilities: GPT, embedding, email, R2, and Shopify
│   ├── chunker.js            # Split docs into semantic chunks
│   ├── embeddings.js         # OpenAI embeddings helper
│   ├── emailer.js            # Consultation summary email logic (Resend)
│   ├── gpt.js                # Chat completion wrapper
│   ├── prompt-builder.js     # Message formatting for GPT
│   ├── r2.js                 # R2 key management and cleanup
│   ├── shopify.js            # Shopify customer upsert helper
│   ├── summary.js            # Consultation summary generation
│   └── systemPrompt.js       # Central system prompt for the assistant
├── wrangler.toml             # Router deployment config and bindings
└── package.json
```

`wrangler.toml` points to `workers/router.js` and binds KV and R2 resources used by all handlers.

This document describes the architecture of the AI-powered WhatsApp consultation assistant built for Tata Oro using Cloudflare Workers, OpenAI’s GPT-4o-mini, Twilio’s WhatsApp API, and Cloudflare R2.

---

## 🧱 Core Components

### 1. **Twilio WhatsApp Integration**

- **Sandbox** number used during development: `+1 415 523 8886`
- Production support via Twilio Messaging Service
- Webhook configured to forward all incoming WhatsApp and SMS messages to Cloudflare Worker endpoint

### 2. **Cloudflare Worker**

- Stateless HTTP handler with optional KV + R2 bindings
- Receives webhook POSTs from Twilio
- Parses message content and media URLs
- Formats valid TwiML XML response for WhatsApp/SMS
- Routes messages through GPT-4o-mini and constructs dynamic responses
- Serves a dynamic summary HTML page at `/summary/:conversationId`, rendering live chat history, metadata, and R2-hosted images without any writes or pre-generation.

### 3. **OpenAI GPT-4o-mini API**

- Handles conversation flow using a system prompt that guides step-by-step consultation
- Supports multimodal messages (text + image_url) for curl photo analysis
- Returns messages adapted to WhatsApp constraints (e.g., character count, no emojis in wa.me links)

### 4. **Cloudflare KV (Binding: `CHAT_HISTORY`)**

- Stores per-user session history to preserve multi-turn context
- Retention: 24-hour TTL
 - KV key: `whatsapp:+<phoneNumber>/history.json`
- Supports resetting conversation when users send reset keywords ("reset", "clear", "start over", "new consultation")
  - Uploaded R2 images are deleted during reset to avoid orphaned media
- Stores session metadata alongside history (progress_status, last_active, summary_email_sent, nudge_sent, summary, r2Urls)

### 5. **Cloudflare R2 (Optional Image Hosting)**

- Used to rehost Twilio image URLs for public access
- GPT-compatible media links are generated by downloading from Twilio and uploading to R2
- Enables future re-use of image data and long-term accessibility in summary messages

---

## 🗓️ Scheduled Tasks

`workers/scheduler.js` runs hourly (cron) to:

- Send timeout-based email summaries for incomplete consultations (progress_status = "midway" and no activity >2h)
- Send WhatsApp nudges for stalled consultations (progress_status = "midway" and no activity >2h)

---

## 🔁 Message Flow

```plaintext
User sends message via WhatsApp/SMS → Twilio Webhook → Cloudflare Worker
→ Parse message (body, media) → Check KV for chat history
→ Send structured messages to OpenAI (GPT-4o-mini)
→ Receive assistant reply → Store in KV → Respond to Twilio with TwiML
→ User receives updated message in WhatsApp or SMS
```

---

## 🧠 System Prompt Logic

The assistant uses a system prompt extracted into the `shared/systemPrompt.js` module to guide the step-by-step consultation behavior:

- A bilingual, warm, step-by-step curl consultant
- Collects photos, hair history, product use, curl goals, and expectations
- Responds one question at a time
- Detects unrealistic expectations (e.g., instant curl restoration)
- Produces a WhatsApp-handoff summary when the consultation concludes
- User phone number is injected into the prompt using `{{USER_PHONE}}` at runtime

---

## 🔐 Environment Variables

| Variable                  | Description                                            |
| ------------------------- | ------------------------------------------------------ |
| `OPENAI_API_KEY`          | API key for OpenAI GPT-4o-mini                          |
| `TWILIO_AUTH_TOKEN`       | Twilio auth token for webhook validation and media downloads |
| `TWILIO_ACCOUNT_SID`      | Twilio Account SID for signing requests                |
| `TWILIO_WHATSAPP_NUMBER`  | Twilio WhatsApp sender number (e.g., `whatsapp:+14155238886`) |
| `EMAIL_ENABLED`           | Enable sending consultation summary emails             |
| `EMAIL_PROVIDER`          | Email provider (e.g., `resend`)                        |
| `EMAIL_FROM`              | Sender address for summary emails                      |
| `EMAIL_TO`                | Recipient address for summary emails                   |
| `RESEND_API_KEY`          | API key for Resend email service                       |
| `SHOPIFY_STORE_DOMAIN`    | Domain for the Shopify store (e.g., `tataoro.com`)     |
| `SHOPIFY_API_TOKEN`       | API token for Shopify Admin API                        |
| `WHATSAPP_BASE_URL`       | Base URL for WhatsApp handler (e.g., `https://wa.tataoro.com`)|

Sensitive values (`OPENAI_API_KEY`, `TWILIO_AUTH_TOKEN`, `TWILIO_ACCOUNT_SID`, `RESEND_API_KEY`, `SHOPIFY_API_TOKEN`) should be set via `wrangler secret put`. Other configuration vars belong in the `[vars]` section of `wrangler.toml`.

---

## 📦 R2 Image Handling (If Enabled)

Each image uploaded via WhatsApp is stored under an R2 object key using the following pattern:

```text
whatsapp:+{E164PhoneNumber}/{timestamp}-{index}.jpeg
```

### Example

```text
whatsapp:+14155238886/1700000000000-0.jpeg
whatsapp:+14155238886/1700000005000-1.jpeg
```

### Visual Example

Below is a screenshot from the Cloudflare R2 dashboard illustrating the per-user prefix and object keys:

![Cloudflare R2 Dashboard showing whatsapp:+{E164PhoneNumber}/ prefix](docs/architecture/r2-dashboard-prefix.png)

### Upload & URL Generation

- Downloads image from Twilio via authenticated API call and uploads it to R2 under the above key.
- Generates a public R2 URL by encoding the full key:

  ```js
  const url = `${baseUrl}/images/${encodeURIComponent(key)}`;
  ```

### Cleanup & Reset

- To remove uploaded images (e.g., on conversation reset), delete the full object keys:

  ```js
  // Using stored R2 URLs and helper to extract the keys
  const keys = session.r2Urls.map(r2KeyFromUrl).filter(Boolean);
  await deleteR2Objects(env, keys);

  // Or list and delete all objects by phone prefix
  const prefix = `whatsapp:+${phone}/`;
  const { objects } = await env.MEDIA_BUCKET.list({ prefix });
  await deleteR2Objects(env, objects.map((o) => o.key));
  ```

**Note:** When calling `env.MEDIA_BUCKET.delete(key)`, always include the full object key with the `whatsapp:+{E164PhoneNumber}/` prefix.

This ensures cleanup uses the complete `whatsapp:+phone/...` prefix when deleting objects in R2.

---

## Public Media Delivery

A dedicated `images` Worker serves public R2-hosted objects. It accepts only `GET` requests and returns the object's body with the original `Content-Type`. Other Workers must not handle `/images/*`.

---

## 🛠️ wrangler.toml

The project deploys a single Worker with a router. A minimal `wrangler.toml` looks like:

```toml
name = "tataoro-router"
compatibility_date = "2025-05-18"
main = "workers/router.js"
route = "https://wa.tataoro.com/*"

[[kv_namespaces]]
binding = "CHAT_HISTORY"
id = "d153e5f2f8fd404e8e7778c494396215"

[[kv_namespaces]]
binding = "DOC_KNOWLEDGE"
id = "c4281158fd7346fdac1f9e10bc092079"

[[r2_buckets]]
binding = "MEDIA_BUCKET"
bucket_name = "tataoro-chat-images"
preview_bucket_name = "tataoro-chat-images"

[vars]
EMAIL_ENABLED = true
EMAIL_PROVIDER = "resend"
EMAIL_FROM = "consultations@tataoro.com"
EMAIL_TO = "tatacurly@tataoro.com"
SHOPIFY_STORE_DOMAIN = "tataoro.com"
WHATSAPP_BASE_URL = "https://wa.tataoro.com"

[observability.logs]
enabled = true
```
---

## 🧪 Testing

### WhatsApp:

1. Join Twilio sandbox using join keyword
2. Message sandbox number
3. Observe logs with `wrangler tail`

### Curl Simulation:

```bash
curl -X POST https://wa.tataoro.com \
  -d "From=whatsapp:+14155238886" \
  -d "To=whatsapp:+14155238886" \
  -d "Body=Hi" \
  -d "NumMedia=1" \
  -d "MediaUrl0=https://example.com/photo.jpg"
```

---

## 📋 Related Design Files

- `docs/issues/05-closed/VIBE_PROMPT.md`: Consultation system prompt and high-level requirements
- `docs/VIBE_CHECK.md`: Testable requirements checklist for worker implementation
- `docs/architecture/async-flow.md`: Flow of messages, integration triggers, and async jobs
- `docs/architecture/openai-routing.md`: GPT summary generation and R2 integration design
- `docs/architecture/kv-state-machine.md`: Session state machine and KV management
- `docs/architecture/image-discovery-from-r2.md`: Dynamic image listing strategy from R2
- `docs/architecture/antifragile-integrations.md`: Resilience patterns for external service failures
- `docs/features/implemented/`: Detailed specs for each implemented feature (Shopify, email, nudges, etc.)

---

## 📦 Next Enhancements (Optional)

- ✅ Add webhook signature validation (`X-Twilio-Signature`)
- ✅ Add summary log to Notion or Google Sheets
- ✅ Build multilingual UI toggle via GPT
- ✅ Cleanup expired sessions in KV
- ✅ Archive image references in R2 for long-term reuse
