# 🏗️ ARCHITECTURE.md

## Tata Oro WhatsApp Consultation Assistant – Architecture Overview

## 📁 New Project Structure

```bash
tataoro-assistant/
├── workers/
│   ├── whatsapp/            # WhatsApp Worker (moved from `index.js`)
│   │   └── index.js
│   ├── doc-sync/            # New Worker to fetch GitHub files + embed
│   │   └── index.js
│   ├── upload-hook/         # Optional: GitHub webhook to auto-trigger sync
│   │   └── index.js
├── shared/                  # Reusable GPT, chunking, embedding utilities
│   ├── gpt.js
│   ├── embeddings.js
│   ├── chunker.js
│   └── prompt-builder.js
├── wrangler.toml            # Multi-worker deployment config
└── package.json
```

This document describes the architecture of the AI-powered WhatsApp consultation assistant built for Tata Oro using Cloudflare Workers, OpenAI’s GPT-4o-mini, Twilio’s WhatsApp API, and Cloudflare R2.

---

## 🧱 Core Components

### 1. **Twilio WhatsApp Integration**

- **Sandbox** number used during development: `+1 415 523 8886`
- Production support via Twilio Messaging Service
- Webhook configured to forward all incoming WhatsApp and SMS messages to Cloudflare Worker endpoint

### 2. **Cloudflare Worker**

- Stateless HTTP handler with optional KV + R2 bindings
- Receives webhook POSTs from Twilio
- Parses message content and media URLs
- Formats valid TwiML XML response for WhatsApp/SMS
- Routes messages through GPT-4o-mini and constructs dynamic responses

### 3. **OpenAI GPT-4o-mini API**

- Handles conversation flow using a system prompt that guides step-by-step consultation
- Supports multimodal messages (text + image_url) for curl photo analysis
- Returns messages adapted to WhatsApp constraints (e.g., character count, no emojis in wa.me links)

### 4. **Cloudflare KV (Binding: `CHAT_HISTORY`)**

- Stores per-user session history to preserve multi-turn context
- Retention: 24-hour TTL
- Memory key: `chat_history:<phoneNumber>`

### 5. **Cloudflare R2 (Optional Image Hosting)**

- Used to rehost Twilio image URLs for public access
- GPT-compatible media links are generated by downloading from Twilio and uploading to R2
- Enables future re-use of image data and long-term accessibility in summary messages

---

## 🔁 Message Flow

```plaintext
User sends message via WhatsApp/SMS → Twilio Webhook → Cloudflare Worker
→ Parse message (body, media) → Check KV for chat history
→ Send structured messages to OpenAI (GPT-4o-mini)
→ Receive assistant reply → Store in KV → Respond to Twilio with TwiML
→ User receives updated message in WhatsApp or SMS
```

---

## 🧠 System Prompt Logic

The assistant behaves as:

- A bilingual, warm, step-by-step curl consultant
- Collects photos, hair history, product use, curl goals, and expectations
- Responds one question at a time
- Detects unrealistic expectations (e.g., instant curl restoration)
- Produces a WhatsApp-handoff summary when the consultation concludes

---

## 🔐 Environment Variables

| Variable             | Description                                            |
| -------------------- | ------------------------------------------------------ |
| `OPENAI_API_KEY`     | Secure API key for OpenAI GPT-4o-mini                  |
| `TWILIO_AUTH_TOKEN`  | Used for Twilio media downloads and webhook validation |
| `TWILIO_ACCOUNT_SID` | Used for R2 proxy or image access routing              |

All secrets are stored securely via `wrangler secret put`.

---

## 📦 R2 Image Handling (If Enabled)

- Downloads image from Twilio via authenticated API call
- Rehosts it to R2 using Worker’s R2 binding
- Generates a public R2 URL
- Injects URL into GPT input message as valid `image_url`
- R2 URL also included in consultation summary for Tata

---

## 🛠️ wrangler.toml (Multi-Worker Setup)

Update your `wrangler.toml` to define environments for each Worker:

```toml
name = "tataoro-gpt"
compatibility_date = "2025-05-18"

[env.whatsapp]
main = "workers/whatsapp/index.js"
name = "tataoro-whatsapp"
route = "https://wa.tataoro.com/*"
kv_namespaces = [
  { binding = "CHAT_HISTORY", id = "d153e5f2f8fd404e8e7778c494396215" }
]
r2_buckets = [
  { binding = "MEDIA_BUCKET", bucket_name = "tataoro-chat-images", preview_bucket_name = "tataoro-chat-images" }
]

[env.docsync]
main = "workers/doc-sync/index.js"
name = "tataoro-doc-sync"
kv_namespaces = [
  { binding = "DOC_KNOWLEDGE", id = "your-doc-knowledge-kv-id" }
]
# Trigger via cron or CLI — no route needed

[env.uploadhook]
main = "workers/upload-hook/index.js"
name = "tataoro-upload-hook"
route = "https://tataoro.com/uploadhook"

[observability.logs]
enabled = true
```

Each `[env.*]` represents a separate Worker you can deploy independently:

```bash
wrangler deploy --env whatsapp     # deploy WhatsApp handler
wrangler deploy --env docsync      # deploy document sync worker
wrangler deploy --env uploadhook   # deploy webhook handler
```

---

## 🧪 Testing

### WhatsApp:

1. Join Twilio sandbox using join keyword
2. Message sandbox number
3. Observe logs with `wrangler tail`

### Curl Simulation:

```bash
curl -X POST https://wa.tataoro.com \
  -d "From=whatsapp:+14155238886" \
  -d "To=whatsapp:+14155238886" \
  -d "Body=Hi" \
  -d "NumMedia=1" \
  -d "MediaUrl0=https://example.com/photo.jpg"
```

---

## 📋 Related Design Files

- `VIBE_PROMPT.md`: Consultation system prompt
- `VIBE_CHECK.md`: Testable requirements checklist
- `VIBE_FEATURE_SMS.md`: SMS and WhatsApp dual-channel logic
- `VIBE_FEATURE_R2.md`: Handles image proxy + hosting logic via Cloudflare R2

---

## 📦 Next Enhancements (Optional)

- ✅ Add webhook signature validation (`X-Twilio-Signature`)
- ✅ Add summary log to Notion or Google Sheets
- ✅ Build multilingual UI toggle via GPT
- ✅ Cleanup expired sessions in KV
- ✅ Archive image references in R2 for long-term reuse
